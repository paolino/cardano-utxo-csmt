services:
  yaci-cli:
    image: bloxbean/yaci-cli:0.11.0-beta1
    ports:
      - "10000:10000"
    volumes:
      - ./node.properties:/app/config/node.properties
      - node-ipc:/clusters/nodes/node1
    entrypoint: ["/app/yaci-cli"]
    command: ["create-node", "-o", "--start"]
    healthcheck:
      test: ["CMD", "test", "-S", "/clusters/nodes/node1/node.sock"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 10s

  cardano-utxo:
    image: cardano-utxo:e2e
    depends_on:
      yaci-cli:
        condition: service_healthy
    volumes:
      - node-ipc:/node:ro
    command:
      - "--socket-path"
      - "/node/node.sock"
      - "--network"
      - "devnet"
      - "--db-path"
      - "/tmp/e2e-db"
      - "--api-port"
      - "8080"
      - "--skip-node-validation"

  e2e-test:
    image: curlimages/curl:latest
    depends_on:
      cardano-utxo:
        condition: service_started
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for cardano-utxo API..."
        for i in $(seq 1 60); do
          if curl -sf http://cardano-utxo:8080/ready 2>/dev/null; then
            echo ""
            echo "API is ready!"
            echo "Checking sync status..."
            curl -sf http://cardano-utxo:8080/ready | head -c 500
            echo ""
            echo "E2E TEST PASSED"
            exit 0
          fi
          echo "  attempt $i/60 - not ready yet"
          sleep 5
        done
        echo "E2E TEST FAILED - API never became ready"
        exit 1

volumes:
  node-ipc:
