services:
  cardano-node:
    image: ghcr.io/paolino/cardano-node-clients/devnet:10.5.4
    volumes:
      - node-data:/data
    healthcheck:
      test: ["CMD", "test", "-S", "/data/node.sock"]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 10s

  cardano-utxo:
    image: cardano-utxo:e2e
    depends_on:
      cardano-node:
        condition: service_healthy
    volumes:
      - node-data:/data:ro
    command:
      - "--socket-path"
      - "/data/node.sock"
      - "--network"
      - "devnet"
      - "--db-path"
      - "/tmp/e2e-db"
      - "--api-port"
      - "8080"
      - "--skip-node-validation"

  e2e-test:
    image: curlimages/curl:latest
    depends_on:
      cardano-utxo:
        condition: service_started
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for cardano-utxo API..."
        for i in $(seq 1 60); do
          if curl -sf http://cardano-utxo:8080/ready 2>/dev/null; then
            echo ""
            echo "API is ready!"
            echo "Checking sync status..."
            curl -sf http://cardano-utxo:8080/ready | head -c 500
            echo ""
            echo "E2E TEST PASSED"
            exit 0
          fi
          echo "  attempt $i/60 - not ready yet"
          sleep 5
        done
        echo "E2E TEST FAILED - API never became ready"
        exit 1

volumes:
  node-data:
