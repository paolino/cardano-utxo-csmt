name: E2E Preview Chain Sync

on:
  workflow_dispatch:

jobs:
  e2e-preview:
    name: E2E Preview Network Test
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - run: sudo rm -rf /opt&
      - uses: actions/checkout@v4
      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Build executable
        run: nix build .#cardano-utxo --quiet
      - name: Run Mithril bootstrap and chain sync
        run: |
          timeout 2400 ./result/bin/cardano-utxo \
            --network preview \
            --mithril-bootstrap \
            --csmt-db-path /tmp/csmt-e2e-db \
            || exit_code=$?
          # Exit code 124 means timeout - that's expected and OK
          if [ "${exit_code:-0}" -eq 124 ]; then
            echo "Test completed successfully (timeout reached)"
            exit 0
          elif [ "${exit_code:-0}" -ne 0 ]; then
            echo "Test failed with exit code $exit_code"
            exit $exit_code
          fi
