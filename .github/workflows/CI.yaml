name: CI

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - run: sudo rm -rf /opt&
      - uses: actions/checkout@v4
      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Build executable
        run: nix build .#cardano-utxo --quiet
      - name: Build docker image
        run: nix build .#docker-image -o output-docker-image --quiet
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardano-utxo-image
          path: output-docker-image
      - name: Build AppImage
        run: nix bundle --bundler github:ralismark/nix-appimage .#cardano-utxo -o cardano-utxo.AppImage --quiet
      - name: Upload appImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardano-utxo-appImage
          path: cardano-utxo.AppImage
      - name: Build rpm artifact
        run: nix bundle --bundler github:NixOS/bundlers#toRPM .#cardano-utxo -o cardano-utxo.rpm --quiet
      - name: Upload rpm artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardano-utxo-rpm
          path: cardano-utxo.rpm
      - name: Build deb artifact
        run: nix bundle --bundler github:NixOS/bundlers#toDEB .#cardano-utxo -o cardano-utxo.deb --quiet
      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardano-utxo-deb
          path: cardano-utxo.deb
  unit:
    name: Run unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Run Tests
        run: nix run .#unit-tests --quiet
  bench:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Run Benchmarks
        run: nix run .#bench --quiet
  formatting:
    name: Check code formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Check Formatting
        run: nix develop --quiet -c just format
  e2e:
    name: N2C E2E test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download docker image
        uses: actions/download-artifact@v4
        with:
          name: cardano-utxo-image
          path: output-docker-image
      - name: Load and tag docker image
        run: |
          image_file=$(find output-docker-image -type f | head -1)
          loaded=$(docker load < "$image_file" | sed 's/Loaded image: //')
          echo "Loaded: $loaded"
          docker image tag "$loaded" cardano-utxo:e2e
          docker images
      - name: Run E2E test
        run: |
          docker compose -f e2e/docker-compose.yml up \
            --abort-on-container-exit \
            --exit-code-from e2e-test
      - name: Cleanup
        if: always()
        run: docker compose -f e2e/docker-compose.yml down -v
  swagger:
    # check that the swagger file is up to date
    name: Check Swagger documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Check Swagger
        run: |
          nix develop --quiet -c just update-swagger
          if ! git diff --exit-code --quiet docs/assets/swagger.json; then
            echo "Swagger documentation is out of date. Please run 'just update-swagger' and commit the changes."
            exit 1
          fi
